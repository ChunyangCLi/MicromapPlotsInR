# Linked Micromap Plots via the **micromap** R Package {#Ch2}


\chapterauthor{J{\"u}rgen Symanzik, Marcus W. Beck, Michael McManus}


The **micromap**\index{R Packages!micromap} R package [@PaOl2015],
accessible at https://cran.r-project.org/web/packages/micromap/index.html,
will be introduced in this chapter. The reader will learn how to create a 
basic linked micromap plot\index{Linked micromap plot} via this R package. 
Details will be provided how to optimize and fine-tune such a basic plot 
into a publication-worthy final linked micromap plot.


## Introduction {#Ch2-Introduction}


As a reminder, see Chapter \@ref(Ch1) for general style requirements
for our `Micromap Plots in R` book. In particular, please do the following:

- Introduce meaningful labels for the sections, figures, and tables in your chapter.

- Create index entries for all R packages (such as the **micromap**\index{R Packages!micromap} R package)
and for all datasets (such as the _USstates_\index{Datasets!USstates} and _edPov_\index{Datasets!edPov} datasets)
that are used in your chapter.

- Include references for R packages and publications related to your chapter,
such as for the **micromap**\index{R Packages!micromap} [@PaOl2015] and 
**micromapST**\index{R Packages!micromapST} [@CP2015CRAN] R packages
and some micromap articles, book chapters, and books [@Carr2001;@SC2008;@CP2010].

- Also create index entries for main topics such as
linked micromap plots,\index{Linked micromap plot}
conditioned choropleth maps,\index{Conditioned choropleth map}
perceptual group,\index{Perceptual group}
color blindness,\index{Color blindness},
and quantile-quantile plot.\index{Quantile-quantile plot}


## Main {#Ch2-Main}


Here goes the main content of your chapter. Introduce additional sections as needed.

For convenience, Figure \@ref(fig:Ch2-micromap1) shows one linked micromap plot\index{Linked micromap plot}
(which is the same as in Figure \@ref(fig:Ch1-micromap1)), but now formatted in a slightly more meaningful way.


```{r Ch2-micromap1, fig.cap = 'Here is a first micromap example for this chapter. Note that the figure is formatted in a slightly more meaningful way this time.', fig.width = 7, fig.height = 9}
library(micromap)

# initial example

data(USstates)
statePolys <- create_map_table(USstates, "ST")
data(edPov)

# basic figure 1
lmplot(
  stat.data = edPov,
  map.data = statePolys,
  panel.types = c("labels", "dot", "dot", "map"),
  panel.data = list("state", "pov", "ed", NA),
  ord.by = "pov",   
  grouping = 5, 
  median.row = TRUE,
  plot.width = 2, 
  plot.height = 6,
  map.link = c("StateAb", "ID")
)
```


## Code Chunks {#Ch2-CodeChunks}


Example code chunks from Mike's workshop materials. Reduce some of the figures.


```{r Ch2-micromap2, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
#I. Overview of Four Steps to Make a Linked Micromap

### I. A. Geoprocessing of Spatial Data
library(micromap)
sessionInfo()
getwd()

library(labeling)

data("USstates")
#Here is the spatial data
plot(USstates)
head(USstates@data)
```



```{r Ch2-micromap3, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. B. Structure:  Create a Map Table to Link to the Statistical Data
statePolys <- create_map_table(USstates, 'ST')
#The spatial data is now in a simpler form that the micromap package can use
head(statePolys)

data("edPov")
#Here is the statistical data.
head(edPov)
#The spatial and statistical data frames must have a common linking variable.
hist(1:100)
```



```{r Ch2-micromap4, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. C. Draft Micromap Plot
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('dot_legend', 'labels', 'dot', 'dot', 'map'),
       panel.data=list(NA, 'state', 'pov', 'ed', NA),
       ord.by='pov',   
       grouping=5, median.row=TRUE)
```



```{r Ch2-micromap5, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. Basic Modification Exercises of Draft Micromap Plot

### I. D. a) Reorder the previous plot in decreasing order of poverty
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('dot_legend', 'labels', 'dot', 'dot', 'map'),
       panel.data=list(NA, 'state', 'pov', 'ed', NA),
       ord.by='pov',   
       rev.ord=TRUE,
       grouping=5, median.row=TRUE)
```



```{r Ch2-micromap6, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. b) Change the order of the education and poverty panels and sort by decreasing education
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('dot_legend', 'labels', 'dot', 'dot', 'map'),
       panel.data=list(NA, 'state', 'ed', 'pov', NA),
       ord.by='ed',   
       rev.ord=TRUE,
       grouping=5, median.row=TRUE)
```



```{r Ch2-micromap7, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. c) Place the maps on the left side
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('map', 'dot_legend', 'labels', 'dot', 'dot'),
       panel.data=list(NA, NA, 'state', 'ed', 'pov'),
       ord.by='ed',   
       rev.ord=TRUE,
       grouping=5, median.row=TRUE)
```



```{r Ch2-micromap8, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. d) Try some different groupings, such as 6, 6, 6, 6, 3, 6, 6, 6, 6 (and no median.row)
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('map', 'dot_legend', 'labels', 'dot', 'dot'),
       panel.data=list(NA, NA, 'state', 'ed', 'pov'),
       ord.by='ed',   
       rev.ord=TRUE,
       grouping=c(6, 6, 6, 6, 3, 6, 6, 6, 6), median.row=FALSE)
```



```{r Ch2-micromap9, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. e) Align the state names to the left, see panel.att page 5-6 User guide
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('map', 'dot_legend', 'labels', 'dot', 'dot'),
       panel.data=list(NA, NA, 'state', 'ed', 'pov'),
       ord.by='ed',   
       rev.ord=TRUE,
       grouping=c(6, 6, 6, 6, 3, 6, 6, 6, 6), median.row=FALSE,
       panel.att=list(list(3, align='left')))
```



```{r Ch2-micromap10, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. f) Vertically align the state names to the center, see vertical.align page 17 User guide
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('map', 'dot_legend', 'labels', 'dot', 'dot'),
       panel.data=list(NA, NA, 'state', 'ed', 'pov'),
       ord.by='ed',   
       rev.ord=TRUE,
       grouping=c(6, 6, 6, 6, 3, 6, 6, 6, 6), median.row=FALSE,
       vertical.align='center',
       panel.att=list(list(3, align='left')))
```



```{r Ch2-micromap11, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. D. g) Use a divergent 6-class BrBG color scheme from RColorBrewer (which is colorblind safe)
mmplot(stat.data=edPov,
       map.data=statePolys,
       map.link=c('StateAb', 'ID'),
       panel.types=c('map', 'dot_legend', 'labels', 'dot', 'dot'),
       panel.data=list(NA, NA, 'state', 'ed', 'pov'),
       ord.by='ed',   
       rev.ord=TRUE,
       grouping=c(6, 6, 6, 6, 3, 6, 6, 6, 6), median.row=FALSE,
       vertical.align='center',
       colors=brewer.pal(6, "BrBG"),
       panel.att=list(list(3, align='left')))
```


```{r Ch2-micromap12, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. E. Refine the Micromap Plot
mmplot(stat.data=edPov, map.data=statePolys,
        panel.types=c('dot_legend',  'labels', 'dot', 'dot', 'map'),
        panel.data=list(NA, 'state', 'pov', 'ed', NA),
        map.link=c('StateAb', 'ID'),
        ord.by='pov', 
        grouping=5, 
        median.row=TRUE, 
        
        plot.height=9, 
        
        colors=c('red', 'orange', 'green', 'blue', 'purple'),
        
        panel.att=list(list(1, point.type=20, point.border=TRUE, point.size=2),
                       
                       list(2, header='States', panel.width=.8, 
                            align='left', text.size=.9),
                       
                       list(3, header='Percent Living Below\nPoverty Level',
                            graph.bgcolor='lightgray', point.size=1.5,
                            xaxis.ticks=list(10, 15, 20), xaxis.labels=list(10, 15, 20),
                            xaxis.title='Percent'),
                       
                       list(4, header='Percent Adults With\n4+ Years of College',
                            graph.bgcolor='lightgray', point.size=1.5,
                            xaxis.ticks=list(20, 30, 40), xaxis.labels=list(20, 30, 40), 
                            xaxis.title='Percent'),
                       
                       list(5, header='Light Gray Means\nPreviously Displayed',
                            map.all=TRUE, fill.regions='aggregate',
                            active.border.color='black', active.border.size=1.5,
                            inactive.border.color=gray(.7), inactive.border.size=1, 
                            panel.width=.8)))
```



```{r Ch2-micromap13, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### I. F. Refine the Micromap Plot with adjusted ticmarks & ticmark labels
mmplot(stat.data=edPov, map.data=statePolys,
       panel.types=c('dot_legend',  'labels', 'dot', 'dot', 'map'),
       panel.data=list(NA, 'state', 'pov', 'ed', NA),
       map.link=c('StateAb', 'ID'),
       ord.by='pov', 
       grouping=5, 
       median.row=TRUE, 
       
       plot.height=9, 
       
       colors=c('red', 'orange', 'green', 'blue', 'purple'),
       
       panel.att=list(list(1, point.type=20, point.border=TRUE, point.size=2),
                      
                      list(2, header='States', panel.width=.8, 
                           align='left', text.size=.9),
                      
                      list(3, header='Percent Living Below\nPoverty Level',
                           graph.bgcolor='lightgray', point.size=1.5,
                           xaxis.ticks=as.list(extended(min(edPov$pov), max(edPov$pov), 3)), 
                           xaxis.labels=as.list(extended(min(edPov$pov), max(edPov$pov), 3)),
                           xaxis.title='Percent'),
                      
                      list(4, header='Percent Adults With\n4+ Years of College',
                           graph.bgcolor='lightgray', point.size=1.5,
                           xaxis.ticks=as.list(extended(min(edPov$ed), max(edPov$ed), 4)), 
                           xaxis.labels=as.list(extended(min(edPov$ed), max(edPov$ed), 4)), 
                           xaxis.title='Percent'),
                      
                      list(5, header='Light Gray Means\nPreviously Displayed',
                           map.all=TRUE, fill.regions='aggregate',
                           active.border.color='black', active.border.size=1.5,
                           inactive.border.color=gray(.7), inactive.border.size=1, 
                           panel.width=.8)))
```



```{r Ch2-micromap14, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
hist(1:100)
```


## Code Chunks China {#Ch2-CodeChunksChina}


```{r Ch2-micromaChina1, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
#VI. Use of external shapefiles

library(rgeos)
library(rgdal)
library(maptools)

library(micromap)

### Read in the shapefile and simplify the polygons (run this part of the code only once!)

ChinaShapefile <- readOGR("data/China_Shapefiles", "export", verbose = TRUE)
plot(ChinaShapefile)
summary(ChinaShapefile)
```


```{r Ch2-micromaChina2, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
gIsValid(ChinaShapefile, byid = TRUE, reason = TRUE)
ChinaShapefileThin <- thinnedSpatialPoly(ChinaShapefile, 
                                         tolerance = 300, # try 100, 300, 3000, 30000
                                         minarea = 10000000000,
                                         topologyPreserve = TRUE, 
                                         avoidGEOS = TRUE)
ChinaShapefileThin <- gBuffer(ChinaShapefileThin, width = 0, byid = TRUE)
gIsValid(ChinaShapefileThin, byid = TRUE, reason = TRUE)
plot(ChinaShapefileThin)

### Change tolerance to 100, 3000, and 30000 and run the the entire code again, starting with readOGR.
### Which of these is the best choice for tolerance? You may have to enlarge the map.

### If you plan to use LM plots for a research project, you may also want to 
### enlarge small regions or shift far-away regions closer to the main region.
### Talk to me for further information.
```


```{r Ch2-micromaChina3, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### Read in the data

religion <- read.csv("data/China_ReligionData.csv", header = TRUE)

ChinaPolys <- create_map_table(ChinaShapefileThin, "ename")

### Basic micromap plot

ChinaPlot <- mmplot(stat.data = religion,
                    map.data = ChinaPolys,
                    panel.types = c("labels", "dot", "map"),
                    panel.data = list("Province", "Christianity", NA),
                    ord.by = "Christianity",
                    grouping = 5,
                    median.row = TRUE, 
                    map.link = c("Province", "ID"))
```


```{r Ch2-micromaChina4, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### Advanced micromap plot

ChinaReligion <- mmplot(stat.data = religion, 
                        map.data = ChinaPolys,
                        panel.types = c("map", "dot_legend", "labels", 
                                        "dot", "dot", "dot", "dot"),
                        panel.data = list(NA, NA, "Province", 
                                          "Christianity", "Buddhism", "Daoism", "Islam"),
                        map.link = c("Province", "ID"),
                        ord.by = "Christianity",
                        rev.ord = TRUE,
                        
                        grouping = 5,
                        median.row = TRUE,
                        plot.height = 9,
                        plot.width = 9,
                        colors = c("red", "orange", "green", "blue", "purple"),
                        two.ended.maps = TRUE,
                        map.all = TRUE,
                        map.color2 = "lightgray",
                        
                        plot.header = "Religion in China",
                        plot.header.size = 2,
                        plot.header.color = "black",
                        
                        plot.panel.spacing = 0,
                        panel.att = list(
                          list(1, header = "Two-ended\nCumulative Maps",
                               inactive.border.color = gray(.7), 
                               inactive.border.size = 1,
                               panel.width = 1.2),
                          list(2, point.type = 20,
                               point.size = 1.4),
                          list(3, header = "Provinces", 
                               panel.width = .9,
                               align = "left", 
                               text.size = .8),
                          list(4, header = "Christianity",
                               header.color = "red",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               xaxis.ticks = seq(0, 3000, by = 1000), 
                               xaxis.labels = seq(0, 3, by = 1),
                               xaxis.title = "Number (Thousand)"
                          ),
                          list(5, header = "Buddhism",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               xaxis.ticks = seq(0, 3000, by = 1000), 
                               xaxis.labels = seq(0, 3, by = 1),
                               xaxis.title = "Number (Thousand)"
                          ),
                          list(6, header = "Daoism",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               xaxis.ticks = seq(0, 2000, by = 1000), 
                               xaxis.labels = seq(0, 2, by = 1),
                               xaxis.title = "Number (Thousand)"
                          ),
                          list(7, header = "Islam",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               xaxis.ticks = seq(0, 25000, by = 12500), 
                               xaxis.labels = seq(0, 25, by = 12.5),
                               xaxis.title = "Number (Thousand)"
                          )
                        )
)
```


```{r Ch2-micromaChina5, fig.cap = 'Chunk 1.', fig.width = 7, fig.height = 9}
### Final advanced micromap plot with reduced margins

ChinaReligion <- mmplot(stat.data = religion, 
                        map.data = ChinaPolys,
                        panel.types = c("map", "dot_legend", "labels", 
                                        "dot", "dot", "dot", "dot"),
                        panel.data = list(NA, NA, "Province", 
                                          "Christianity", "Buddhism", "Daoism", "Islam"),
                        map.link = c("Province", "ID"),
                        ord.by = "Christianity",
                        rev.ord = TRUE,
                        
                        grouping = 5,
                        median.row = TRUE,
                        plot.height = 9,
                        plot.width = 9,
                        colors = c("red", "orange", "green", "blue", "purple"),
                        two.ended.maps = TRUE,
                        map.all = TRUE,
                        map.color2 = "lightgray",
                        
                        plot.header = "Religion in China",
                        plot.header.size = 2,
                        plot.header.color = "black",
                        
                        plot.panel.spacing = 0,
                        panel.att = list(
                          list(1, header = "Two-ended\nCumulative Maps",
                               inactive.border.color = gray(.7), 
                               inactive.border.size = 1,
                               panel.width = 1.2),
                          list(2, point.type = 20,
                               point.size = 1.4),
                          list(3, header = "Provinces", 
                               panel.width = .9,
                               align = "left", 
                               text.size = .8),
                          list(4, header = "Christianity",
                               header.color = "red",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               right.margin = 0, 
                               left.margin = -0.5,
                               xaxis.ticks = seq(0, 3000, by = 1000), 
                               xaxis.labels = seq(0, 3, by = 1),
                               xaxis.title = "Number (Thousand)"
                          ),
                          list(5, header = "Buddhism",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               right.margin = 0, 
                               left.margin = -0.5,
                               xaxis.ticks = seq(0, 3000, by = 1000), 
                               xaxis.labels = seq(0, 3, by = 1),
                               xaxis.title = "Number (Thousand)"
                          ),
                          list(6, header = "Daoism",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               right.margin = 0, 
                               left.margin = -0.5,
                               xaxis.ticks = seq(0, 2000, by = 1000), 
                               xaxis.labels = seq(0, 2, by = 1),
                               xaxis.title = "Number (Thousand)"
                          ),
                          list(7, header = "Islam",
                               graph.bgcolor = "lightgray", 
                               point.size = 1,
                               right.margin = 0.25, 
                               left.margin = -0.5,
                               xaxis.ticks = seq(0, 25000, by = 12500), 
                               xaxis.labels = seq(0, 25, by = 12.5),
                               xaxis.title = "Number (Thousand)"
                          )
                        )
)
```


## Further Reading {#Ch2-FurtherReading}


Introduce cross-references to other chapters, e.g., Chapter \@ref(Ch1) and Chapter \@ref(Ch3),
where related work and further examples can be found in this book that match the content of this
chapter, that follow up on this chapter, or that are a prerequisite of this chapter.

Also, do some scientific literature review here that is specific to your chapter.
Where has this R package been introduced and used before, where have other plot types
or different countries been used in micromaps, what were other applications 
of micromaps that are related to the title and content of your chapter, etc.?


\printbibliography[segment=\therefsegment,heading=subbibliography]

