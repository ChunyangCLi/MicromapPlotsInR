\mainmatter


# An Introduction to Micromaps {#Ch1}


\chapterauthor{J{\"u}rgen Symanzik}


Welcome to the _Micromap Plots in R Book_. In this chapter, we provide a basic
overview of micromap visualizations, introduce the nomenclature used
throughout the book, and introduce the primary software used
for micromap visualizations. Also provided are an outlook on the
chapters of this book and how to best use the accompanying R code,
webpage, and newly developed R package.


## Introduction {#Ch1-Introduction}


Micromap visualizations\index{Micromap visualizations} are an important tool
for the visualization of statistical data in a geographic context,
providing a rich context for interpretation.
Micromap visualizations\index{Micromap visualizations} consist of a series of small maps, the _micromaps_,
that are used to show spatial patterns and that are also used to highlight 
or link to underlying statistical data. 
There exist three main types of micromaps, i.e.,
linked micromap plots\index{Linked micromap plot},
introduced in Section \@ref(Ch1-LinkedMicromapPlots),
conditioned micromaps\index{Conditioned micromaps},
introduced in Section \@ref(Ch1-ConditionedMicromaps), and
comparative micromaps\index{Comparative micromaps}
introduced in Section \@ref(Ch1-ComparativeMicromaps).
Our nomenclature will closely follow the one from @SCMW2017.
Alternatives can sometimes be found in the literature,
but should be easy to match with the terminology used in this book.

After introducing these three main types of micromaps,
we take a closer look at software and online developments
for micromaps in Section \@ref(Ch1-SoftwareOnlineDevelopments)
that cover almost 40 years of micromap developments.
What follows in Section \@ref(Ch1-Outlook)
is an outlook on the 14 chapters in this book.
Finally, Section \@ref(Ch1-HowToUse) will provide
some recommendations how to best use this book and
the accompanying R code, webpage, and the newly developed
**micromapExtra**\index{R Packages!micromapExtra} R package.


## Linked Micromap Plots {#Ch1-LinkedMicromapPlots}


## Conditioned Micromaps {#Ch1-ConditionedMicromaps}


## Comparative Micromaps {#Ch1-ComparativeMicromaps}


## Software and Online Developments {#Ch1-SoftwareOnlineDevelopments}


## Outlook on the Book Chapters {#Ch1-Outlook}


## How to Use this Book and the Accompanying R Code, Webpage, and R Package {#Ch1-HowToUse}



## INSTRUCTIONS FOR CHAPTER AUTHORS: Use of Bookdown {#Ch1-InstructionsChapterAuthors}


Please look at the source code for this chapter (i.e., the file `01-introduction.Rmd`) carefully. 
It provides an overview how to label and reference other chapters, sections, figures, and tables in your chapter.
It also outlines how and what to index and how to include citations in your chapter.

Eventually, this chapter will become the real introduction for our `Micromap Plots in R` book.
Minimal templates for actual chapters can be found in the files `02-micromap.Rmd`, `03-micromapST.Rmd`, etc.

The ultimate summary for this chapter will be based on the following text:

This chapter will provide a brief overview of the history of micromap plots, 
main application areas, and existing software for the creation of micromaps. 
A summary of the following eleven chapters of this book will also be provided.


## Use of Bookdown {#Ch1-Bookdown}


This section contains some basic information related to bookdown. For further details, see
https://bookdown.org/
and specifically
https://bookdown.org/yihui/bookdown/.

For an overview how to use bookdown for CRC Press / Taylor & Francis books, see
https://yihui.org/en/2018/08/bookdown-crc/
and
https://www.routledge.com/bookdown-Authoring-Books-and-Technical-Documents-with-R-Markdown/Xie/p/book/9781138700109.


## Creating Figures and Tables {#Ch1-FigsAndTables}


Here are some basic examples how to create figures and tables in bookdown.
We have a figure in Figure \@ref(fig:Ch1-CarsScatterplot) that makes
use of the _cars_\index{Datasets!cars} dataset
and also a table in Table \@ref(tab:Ch1-IrisTable) that makes
use of the _iris_\index{Datasets!iris} dataset.
See these examples how to create automatic figure and table numbers in your R code chunks 
and how to reference them in the main text. Also, please cite all data sets that
are used in your chapter.

Use meaningful identifiers that start with the letters **Ch**, 
followed by the number of your chapter and a dash (such as Ch1-, Ch2-, etc.) so that we
can eventually cross-reference figures across chapters (and also avoid that the 
same identifier is used more than once in different chapters).


```{r Ch1-CarsScatterplot, out.width = '90%', fig.cap = 'A trivial scatterplot of the cars data set.'}
par(mar = c(4, 4, 1, 0.1))
plot(cars, pch = 19)
```


```{r Ch1-IrisTable}
knitr::kable(
  head(iris), 
  caption = "A table of the iris data.",
  booktabs = TRUE
)
```

## Indexing {#Ch1-Indexing}


As already done in the previous sections, index all R packages such as
**ggplot2**\index{R Packages!ggplot2} and
**ggmap**\index{R Packages!ggmap} R packages.

Also provide an index entry for all datasets, such as the
_cars_\index{Datasets!cars} and the _iris_\index{Datasets!iris} datasets.

For R packages and datasets, use the actual R spelling. Do not change the capitalization.

One final word on indexing: Please capitalize the first word of the index entry in a sequence of words, e.g.,
perceptual group,\index{Perceptual group}
color blindness,\index{Color blindness},
and quantile-quantile plot.\index{Quantile-quantile plot}

In case you want to use abbreviations, please introduce them first, e.g.,
linked micromap plots\index{Linked micromap plot} (LMplots\index{LMplot|see {Linked micromap plot}}) and
conditioned choropleth maps\index{Conditioned choropleth map} (CCmaps\index{CCmap|see {Conditioned choropleth map}}).

Introduce a cross-reference index entry for the abbreviation (see the examples above),
but always list the full length-index entry for the index.

See https://en.wikibooks.org/wiki/LaTeX/Indexing
for other indexing options.


## Citations and References {#Ch1-CitationsReferences}


Here are some examples for citations: @Xie2022knitr and @Xie2022bookdown are references from the preface.
These citations appear as nouns in the text.

These are some micromap articles, book chapters, and books [@Carr2001;@SC2008;@CP2010].
These are references for the **micromap**\index{R Packages!micromap} [@PaOl2015] and 
**micromapST**\index{R Packages!micromapST} [@CP2015CRAN] R packages.
All of these citations appear in parentheses. 
**Note the use of the semicolon in the first set of articles, book chapters, and books.**
Also note that three different bib files have been used here to create the final bibliography.

See here for further details on citations in bookdown:
https://bookdown.org/yihui/bookdown/citations.html.

**I have provided an updated bibtex file with a large number of micromap-related references,
called `referencesMicromaps.bib` - see 
https://github.com/symanzik/MicromapPlotsInR/blob/master/referencesMicromaps.bib.
See Appendix \@ref(Ch99-MicromapReferenceOverview) for the references that are already listed
in the bibtex file.
Most of the underlying articles, book chapters, posters, etc. have been made available via a Box folder now.
You should have received an e-mail invitation to this Box folder on 3/25/2022.
If you did not receive such an invitation or cannot access the files,
please let me know.**


## Micromap Examples {#Ch1-MicromapExamples}


While Section \@ref(Ch1-FigsAndTables) discussed general figure and table creation, this section focuses on micromaps.

The following examples have been taken from the `lmplot()` help page of the **micromap**\index{R Packages!micromap} R package.
Figure \@ref(fig:Ch1-micromap1) shows the first basic linked micromap plot\index{Linked micromap plot}
that makes use of the _USstates_\index{Datasets!USstates} and _edPov_\index{Datasets!edPov} datasets.

Overall, write and format your R code according to the tidyverse R style, summarized at
https://style.tidyverse.org/index.html.
As many of our function calls for micromaps require a large number arguments, see Section 2.5 called `Long Lines'
(https://style.tidyverse.org/syntax.html#long-lines)
how to format such function calls.


```{r Ch1-micromap1, out.width = '90%', fig.cap = 'Here is a first micromap example. Note that it occupies 90 percent of the page width. The rows are far too much condensed.'}
library(micromap)

# initial example

data(USstates)
head(USstates@data)
statePolys <- create_map_table(USstates, "ST")
head(statePolys)

data(edPov)

# basic figure 1
lmplot(
  stat.data = edPov,
  map.data = statePolys,
  panel.types = c("labels", "dot", "dot", "map"),
  panel.data = list("state", "pov", "ed", NA),
  ord.by = "pov",   
  grouping = 5, 
  median.row = TRUE,
  plot.width = 2, 
  plot.height = 6,
  map.link = c("StateAb", "ID")
)
```


This gets further refined now. Figure \@ref(fig:Ch1-micromap2) shows the resulting second micromap plot.


```{r Ch1-micromap2, fig.cap = 'And here is a second micromap example. This uses the default output settings. This still looks very bad.'}
# publication figure 1a
lmplot(
  stat.data = edPov,
  map.data = statePolys ,
  panel.types = c("labels", "dot", "dot", "map"),
  panel.data = list("state", "pov", "ed", NA),
  ord.by = "pov",  
  grouping = 5,
  median.row = TRUE,
  map.link = c("StateAb", "ID"),
  
  plot.height = 9,
  
  colors = c("red", "orange", "green", "blue", "purple"), 
  map.color2 = "lightgray",
  
  panel.att = list(
    list(1, header = "States", 
         panel.width = 0.8, 
         align = "left", 
         text.size = 0.9),
    list(2, header = "Percent Living Below\nPoverty Level",
         graph.bgcolor = "lightgray", 
         point.size = 1.5,
         xaxis.ticks = list(10, 15, 20), 
         xaxis.labels = list(10, 15, 20),
         xaxis.title = "Percent"),
    list(3, header = "Percent Adults With\n4+ Years of College",
         graph.bgcolor = "lightgray", 
         point.size = 1.5,
         xaxis.ticks = list(10, 20, 30, 40), 
         xaxis.labels = list(10, 20, 30, 40),
         xaxis.title = "Percent"),
    list(4, header = "Light Gray Means\nHighlighted Above",  
         inactive.border.color = gray(0.7), 
         inactive.border.size = 2,	
         panel.width = 0.8)
  )
)
```


Some more refinements, resulting in Figure \@ref(fig:Ch1-micromap3).


```{r Ch1-micromap3, fig.cap = 'And now the third (revised) micromap example. Note that this specifies a width and height for the figure. This may be the best solution to scale the micromap plots.', fig.width = 7, fig.height = 9}
edPov$points <- 0	

# publication figure 1b
lmplot(
  stat.data = edPov, 
  map.data = statePolys,
  panel.types = c("dot", "labels", "dot", "dot", "map"),
  panel.data = list("points", "state", "pov", "ed", NA),
  map.link = c("StateAb", "ID"),
  ord.by = "pov", 
  grouping = 5, 
  median.row = TRUE, 
  
  plot.height = 9, 
  
  colors = c("red", "orange", "green", "blue", "purple"),
  map.color2 = "lightgray", 
  
  panel.att = list(
    list(1, panel.width = 0.15, 
         point.type = 20,
         graph.border.color = "white",
         xaxis.text.display = FALSE, 
         xaxis.line.display = FALSE,
         graph.grid.major = FALSE),
    
    list(2, header = "States", 
         panel.width = 0.8, 
         align = "left", 
         text.size = 0.9),
    
    list(3, header = "Percent Living Below\nPoverty Level",
         graph.bgcolor = "lightgray", 
         point.size = 1.5,
         xaxis.ticks = list(10, 15, 20), 
         xaxis.labels = list(10, 15, 20),
         xaxis.title = "Percent"),
    
    list(4, header = "Percent Adults With\n4+ Years of College",
         graph.bgcolor = "lightgray", 
         point.size = 1.5,
         xaxis.ticks = list(20, 30, 40), 
         xaxis.labels = list(20, 30, 40), 
         xaxis.title = "Percent"),
    
    list(5, header = "Light Gray Means\nHighlighted Above", 
         inactive.border.color = gray(0.7), 
         inactive.border.size = 2, 
         panel.width = 0.8)
  )
)
```


## Alternative Creation and Inclusion of Figures {#Ch1-AlternativeMicromapExample}


Final refinements. Here, the code is run separately. The figure is not shown directly.
Rather, an external figure (jpeg or pdf) is created. Eventually, 
in Figure \@ref(fig:Ch1-micromap5), this externally created figure is included into the text.

**Even though this works, I would suggest to always use the approach from the previous section, i.e.,
Section \@ref(Ch1-MicromapExamples), whenever possible.** Exceptions are externally created files
or sceenshots, e.g., from a **Shiny**\index{R Packages!shiny} app, that could be included this way.  Note that the external figures should be placed in the `img` folder and should be jpeg format.


```{r Ch1-micromap4}
# publication figure 1c
lmplot(
  stat.data = edPov, 
  map.data = statePolys,
  panel.types = c("map", "dot",  "labels", "dot", "dot"),
  panel.data = list(NA, "points", "state", "pov", "ed"),
  map.link = c("StateAb", "ID"),
  ord.by = "pov", 
  grouping = 5, 
  median.row = TRUE,
  
  plot.height = 9, 
  
  colors = c("red", "orange", "green", "blue", "purple"),
  map.color2 = "lightgray", 
  
  print.file = "img/Ch1-micromap4-external.jpeg",
  
  panel.att = list(
    list(2, panel.width = 0.15, 
         point.type = 20,
         graph.border.color = "white",
         xaxis.text.display = FALSE, 
         xaxis.line.display = FALSE,
         graph.grid.major = FALSE),
    
    list(3, header = "States", 
         panel.width = 0.8, 
         align = "left", 
         text.size = 0.9),
    
    list(4, header = "Percent Living Below\nPoverty Level",
         graph.bgcolor = "lightgray", 
         point.size = 1.5,
         xaxis.ticks = list(10, 15, 20), 
         xaxis.labels = list(10, 15, 20),
         xaxis.title = "Percent"),
    
    list(5, header = "Percent Adults With\n4+ Years of College",
         graph.bgcolor = "lightgray", 
         point.size = 1.5,
         xaxis.ticks = list(20, 30, 40), 
         xaxis.labels = list(20, 30, 40), 
         xaxis.title = "Percent"),
    
    list(1, header = "Light Gray Means\nHighlighted Above", 
         inactive.border.color = gray(0.7), 
         inactive.border.size = 2, 
         panel.width = 0.8)
  )
)
```


```{r Ch1-micromap5, fig.cap = 'And now the fourth (and final) micromap example.', out.width = '90%', echo = FALSE}
#options(knitr.graphics.auto_pdf = TRUE)

knitr::include_graphics("img/Ch1-micromap4-external.jpeg")
```

\newpage


## Translating the Book Chapters to pdf and html Output {#Ch1-Translating}


**The following instructions assume that you will be working locally on your
own computer on your own chapter only. If you are familiar with git and github
(and how to use these from RStudio), adjust the workflow accordingly
to directly collaborate and interact with other chapter authors 
who will be using git and github. The use of git and github is optional.
If you do not want to use these, you can always provide me with your Rmd
and other source files.**

Our book lives on
https://github.com/symanzik/MicromapPlotsInR.
This is a public directory. Everyone will be able to see the advancement
of our book and provide feedback. I plan to provide stable updates on
a regular basis. If you are familiar with git and github, simply pull
new versions from the repository.

If you do not want to use git and github at this time, please do the following:
Select `Code -> Download ZIP` on the github page above.
Unzip the ZIP file where you want to host these files locally on your computer.

Open the R project file `MicromapPlotsinR.Rproj` in RStudio by double clicking on it.
Ideally, always work in the framework of this R project while working on your book chapter.

Open the Rmd file that serves as a template for your chapter, e.g., `02...Rmd`. Also open 
`index.Rmd` and `01-introduction.Rmd` to see how certain features 
(such as R code, references, index entries, etc.) can be produced in bookdown.
To do so, simply click on the file names in the RStudio **Files** menu.

Bookdown assumes that all files with extension .Rmd in a directory belong to the same book project.
The file `index.Rmd` always is the main document. All additional Rmd files are read in sequential
alpha-numerical order. For this book, you can initially speed up the translation process if you move files
`02...Rmd`, `03...Rmd`, etc. (except your own chapter) into a different directory so they do not
get translated each time. However, this means that cross-references to different chapters will
not work. So, when you are about to finalize your chapter, please translate with all currently
provided Rmd files in place (i.e., copy these files back into your local directory).
Keep all other files and directories in the same directory structure as provided by me!
These are needed to produce the book, but it is unlikely that you have to edit them at all.
You likely will run into errors when trying to translate to pdf or html if some
of these files are missing.

Please do not modify the file `index.Rmd` on your side at all. If something needs
to be changed, it likely needs to be changed for all chapters. So, please let me know about such
necessary changes for the `index.Rmd` file. You should be fine if you just edit
the Rmd file for your chapter, i,e., `02...Rmd`, `03...Rmd`, etc.

Note that the short chapter summary at the start of a chapter 
has been adapted from my original book proposal for CRC Press.
Adjust as needed when your chapter is being written.
Also adjust your names, e.g., insert missing middle initials,
and change the author order as desired for your chapter.

To translate your chapter to html or pdf (and in fact, also translate all other Rmd files
that are in this directory), select **Build** from the RStudio menu that appears next to
**Environment** and **History** (often in the upper right corner of RStudio).
Note that there exists a second **Build** in the top menu of RStudio
(close to **Session** and **Debug**) -- this is not what we need.
You now should see the menu **Build Book**. 
Select **bookdown::pdf_book** to create the pdf version of the book.
Alternatively, select **bookdown::gitbook** to create the html version of the book.

If your translation to html or pdf does not work immediately, try the following:

- Check that you have all necessary R packages installed, in particular **bookdown**, **micromap**,
**micromapST**, and all their dependencies.  Note that the dependencies should be installed
automatically with each package, but some may require manual installation.
Chapter \@ref(Ch2) also needs the **labeling**, **rgeos**, **rgdal**, and **maptools** R packages.
If necessary, install missing R packages (and their dependencies) via 
`Tools -> Install Packages` in RStudio.

- Do you have recent versions (from 2022) of RStudio and R itself? If not, update them.
Updating R can be done most easiest via the `installr` R package and its `updateR()` function.
One recommendation: Do not delete the R packages from your current installation of R
until you are sure that they have been successfully transferred into the new installation of R.

- Are all R packages up to date? Check via `Tools -> Check for Package Updates`
in RStudio. Mismatching packages may be incompatible.
If packages still do not match, enforce an update of all R packages via 
the following. This is also a good idea when you updated to a new version of R,
but copied all your currently installed R packages to the new location:
```{r Ch1-UpdateRPackages, eval = FALSE}
update.packages(checkBuilt = TRUE, ask = FALSE)
```

At this time, you should be able to translate to html. Translation to pdf
may still require a few additional steps:

- Do you have some LaTeX version installed? If not, I would suggest
to install the full 6GB `texLive` version from 
https://www.tug.org/texlive/.
Alternatives are ` MiKTeX` (https://miktex.org/) or
`TinyTeX` (https://yihui.org/tinytex/).
After the installation, you should restart your computer.

- If you have a current installation of `MiKTeX` or `TinyTex`, but still
get errors when you try to translate to pdf, update your current installation
(including the used LaTeX packages).
Google for help how to do this for a certain installation of `MiKTeX` or `TinyTex`
for your operating system.

- If all of the above still do not work for you (but you can create the html version),
there are two options: 
(i) Just create the html version. But, this may require some more
back and forth later on during the review process of your chapter. 
(ii) Uninstall your current LaTeX installation, and install 
the full 6GB `texLive` version from 
https://www.tug.org/texlive/. This usually resolves all problems.
 
The html version of the book will be visually more appealing. The pdf version will be more complete.
Note that some of the pdf features of the book do not appear in the html version,
e.g., there are no chapter authors listed, no list of figures and no list of tables is produced,
no index is created, there is a different appearance of the references, and others. 
As the final delivery to CRC Press are the source files for the pdf version,
we do not have to focus on the html version at this time (but create the html
version if you don't get the translation to pdf to work on your side). If you are aware
how to modify the code (Rmd, yml, or other) to obtain a matching html version
for some of the missing / different features, please let me know. As far as I could see,
some of these features do not even exist for the html version at this time,
but of course, might be implemented while we are working on the book.

At this time, do not worry about any formatting issues, placement of figures, etc. 
in the pdf version. These will be addressed only once all chapter content has been finalized.


## External Data Files and Additional R Code {#Ch1-DataFilesRCode}


Likely, several of the book chapters are based on external data files and/or 
additional R code. Eventually, these have to be made available to our readers
in a meaningful way. This could be done via additional (new) R packages,
e.g., `MPIRdata` or `micromapExtra`. The underlying R code for some of the chapters 
itself could result in new R packages on CRAN or github. There are numerous
options. We do not have to decide at this time, but only later in the year
once we know how much additional material (data and R code) there will be.

For now, let's just deposit any external data and additional R code that is 
not directly part of a chapter into the `data` directory at 
https://github.com/symanzik/MicromapPlotsInR/data.
Please send your data and additional R files to me, best as a zip file, so
I can upload them to github.  Alternatively, the data can be pushed directly 
to the GitHub repository from a local version if you are familiar with Git 
and GitHub.

Overall, this will allow us to share data and additional R code among multiple
chapters. Someone may want to use a modified shapefile, a new plot type,
or create a different type of a Shiny app based on a micromap plot
introduced elsewhere in the book.

Assuming that the data directory is at the same directory level as the Rmd file
of a chapter, data can be imported into a chapter as follows:

```{r Ch1-Data, eval = FALSE}
data <- read.csv("data/file.csv")
load(file = "data/file.RData")
```

See Section \@ref(Ch4-CodeChunksChina) how I read in shapefiles and data for Chinese micromaps.
Note that this chapter is still highly experimental at this time!!!


\newpage


## Open Bookdown Questions {#Ch1-OpenBookdownQuestions}


I have to resolve a few open bookdown questions on my side:

- How to modify the appearance of R code chunks, e.g., reduced font size and reduced spacing? See
https://bookdown.org/yihui/rmarkdown-cookbook/chunk-styling.html
and
https://stackoverflow.com/questions/25646333/code-chunk-font-size-in-rmarkdown-with-knitr-and-latex
and
https://github.com/rstudio/rmarkdown/issues/388.
I need to look at some more examples and consult with CRC Press what they want for their books.

- How to add chapter authors to the header of each chapter and to the table of content? See
https://github.com/admindatahandbook/book/issues/4,
https://tex.stackexchange.com/questions/156862/displaying-author-for-each-chapter-in-book,
and
https://stackoverflow.com/questions/41655383/r-markdown-similar-feature-to-newcommand-in-latex/41664105.
This works for the pdf version, but needs some fine-tuning and consultation with CRC Press.

- How to create chapter-specific bibliographies at the end of each chapter, rather than a single
bibliography at the end of the book? See
https://stackoverflow.com/questions/45028623/is-there-a-way-to-add-chapter-bibliographies-using-bookdown,
https://tex.stackexchange.com/questions/525778/multiple-bibliographies-using-natbib-and-chapterbib-bibtex-illegal-error,
https://community.rstudio.com/t/one-bibliography-per-chapter-when-using-pandoc-for-citations/117105/2,
https://github.com/rstub/bookdown-chapterbib,
and
https://tex.stackexchange.com/questions/25701/bibtex-vs-biber-and-biblatex-vs-natbib.
This basically works now, but needs some fine-tuning.

Note that `apa` and `authoryear` settings for `biblio-style` are not exactly the same as `apalike`, 
but they come close. For example, the address field is ignored for books and book chapters. 
Also, notes and URLs are not exactly placed where they should be.
I need to check with CRC Press what is needed on their side.

Also, there may not be a need for a comprehensive bibliography at the end of the book. 
I need to check this with CRC Press as well.


\printbibliography[segment=\therefsegment,heading=subbibliography]

